formatVersion: 1
inputs:
  serviceLevel:
    type: string
    default: nonproduction
    enum:
      - sandbox
      - production
      - nonproduction
  application: #in a real scenario these would be populated dynamically
    type: string
    default: sandbox
    enum:
      - finance
      - sandbox
      - hr
  flavorSize:
    type: string
    default: medium
    enum:
      - small
      - medium
      - large
  image:
    type: string
    default: ubuntu24
    enum:
      - ubuntu24
      - ubuntu22
  diskSize:
    type: integer
    default: 5
    minimum: 1
    maximum: 15
  diskCount:
    type: integer
    default: 0
    minimum: 0
    maximum: 4
resources:
  ubuntuVM-disk:
    type: Cloud.Volume
    properties:
      capacityGb: ${input.diskSize}
      count: ${input.diskCount}
      constraints:
        - tag: storageTier:iscsi
  ubuntuVM:
    type: Cloud.Machine
    properties:
      tags:
        - key: application
          value: ${input.application}
        - key: serviceLevel
          value: ${input.serviceLevel}
      constraints:
        - tag: '!vcfaCapablity:closed:hard'
        - tag: application:hr
      image: ${input.image}
      flavor: ${input.flavorSize}
      attachedDisks: ${map_to_object(resource["ubuntuVM-disk"][*].id, "source")}
      networks:
        - network: ${resource.ubuntuVM-network.id}
      storage:
        constraints:
          - tag: storageTier:iscsi
  ubuntuVM-network:
    type: Cloud.Network
    properties:
      networkType: existing
      constraints:
        - tag: application:hr
